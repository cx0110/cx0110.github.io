name: Deploy website to Glitter Network

env:
  # 保持和你原文件一致的版本
  WC_HUGO_VERSION: '0.152.2'
  NODE_VERSION: '20'

on:
  push:
    branches: ['main']
  workflow_dispatch:

# 这里不需要写 pages: write 的权限，因为不推送到 GitHub Pages
permissions:
  contents: read

jobs:
  deploy-to-glitter:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      if: hashFiles('package.json') != ''
      uses: pnpm/action-setup@v4

    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          echo "Installing Tailwind dependencies..."
          pnpm install || npm install
        fi

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: ${{ env.WC_HUGO_VERSION }}
        extended: true

    # 缓存步骤保持不变，加快构建速度
    - uses: actions/cache@v4
      with:
        path: |
          /tmp/hugo_cache_runner/
          node_modules/
          modules/*/node_modules/
        key: ${{ runner.os }}-hugo-deps-${{ hashFiles('**/go.mod', '**/package-lock.json', '**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-hugo-deps-

    - uses: actions/cache@v4
      with:
        path: resources/
        key: ${{ runner.os }}-hugo-resources-${{ hashFiles('assets/**/*', 'config/**/*', 'hugo.yaml', 'package.json') }}
        restore-keys: |
          ${{ runner.os }}-hugo-resources-

    # 构建步骤：关键修改点
    - name: Build with Hugo for Glitter
      env:
        HUGO_ENVIRONMENT: production
      run: |
        # 将 baseURL 设置为 "/" 或者是你在 Glitter 绑定的自定义域名
        # 如果你只是用 IPFS 网关访问，可能需要开启 relativeURLs: true (视情况而定)
        hugo --minify --baseURL "/"

    - name: Generate Pagefind search index (if applicable)
      run: |
        if [ -f "package.json" ] && grep -q "pagefind" package.json; then
          pnpm dlx pagefind --source "public" || npx pagefind --source "public"
        fi

    # 部署到 Glitter
    - name: Deploy to Glitter via PinMe
      uses: glitternetwork/pinme@main
      with:
        token: ${{ secrets.GLITTER_TOKEN }}
        path: 'public'
