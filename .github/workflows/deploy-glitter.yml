name: Deploy website to Glitter Network

env:
  WC_HUGO_VERSION: '0.152.2'
  NODE_VERSION: '20'

on:
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-to-glitter:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      if: hashFiles('package.json') != ''
      uses: pnpm/action-setup@v4

    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          echo "Installing Tailwind dependencies..."
          pnpm install || npm install
        fi

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: ${{ env.WC_HUGO_VERSION }}
        extended: true

    - uses: actions/cache@v4
      with:
        path: |
          /tmp/hugo_cache_runner/
          node_modules/
          modules/*/node_modules/
        key: ${{ runner.os }}-hugo-deps-${{ hashFiles('**/go.mod', '**/package-lock.json', '**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-hugo-deps-

    - uses: actions/cache@v4
      with:
        path: resources/
        key: ${{ runner.os }}-hugo-resources-${{ hashFiles('assets/**/*', 'config/**/*', 'hugo.yaml', 'package.json') }}
        restore-keys: |
          ${{ runner.os }}-hugo-resources-

    - name: Build with Hugo for Glitter
      env:
        HUGO_ENVIRONMENT: production
      run: |
        hugo --minify --baseURL "/"

    - name: Generate Pagefind search index (if applicable)
      run: |
        if [ -f "package.json" ] && grep -q "pagefind" package.json; then
          pnpm dlx pagefind --source "public" || npx pagefind --source "public"
        fi

    - name: Install pinme CLI
      run: |
        echo "ðŸ“¥ Installing pinme via npm..."
        npm install -g pinme
        echo "âœ… pinme installed"
        pinme --help || pinme -h || true

    - name: Deploy to Glitter Network
      env:
        PINME_APPKEY: ${{ secrets.PINME_APPKEY }}
      run: |
        echo "ðŸ“¦ Uploading ./public to Glitter Network..."
        pinme upload ./public --key "$PINME_APPKEY"
        echo "âœ… Deploy complete!"
